{"version":3,"file":"initinfobox.min.js","sources":["../src/initinfobox.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/.\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package\n * @subpackage organizer\n * @copyright 2020 Thomas Niedermaier (thomas.niedermaier@gmail.com)\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Tab appointments view and students view: Load slot list according to view options stored in user prefs.\n */\n\n\ndefine(['jquery', 'core/config'], function($, config) {\n\n        /**\n         * @constructor\n         * @alias module:mod_organizer/initinfobox\n         */\n        var Initinfobox = function() {\n            this.studentview = 0;\n            this.registrationview = 0;\n            this.userid = 0;\n        };\n\n        var instance = new Initinfobox();\n\n        instance.init = function(studentview, registrationview, userid) {\n\n            instance.studentview = studentview; // Loaded on student view?\n            instance.registrationview = registrationview; // Loaded on registration view?\n            instance.userid = userid; // This user ID.\n\n            /**\n             * What happens when a view option checkbox is clicked or the filter field has been changed.\n             * @param {object} event element which has been clicked\n             */\n            function toggleAllSlots(event) {\n                if (event != undefined && instance.registrationview == 0) {\n                    saveuserpreference();\n                }\n                var tablebody = $('#slot_overview tbody');\n                var showpastslots = $('#show_past_slots').is(':checked');\n                var showmyslotsonly = $('#show_my_slots_only').is(':checked');\n                var showfreeslotsonly = $('#show_free_slots_only').is(':checked');\n                var showhiddenslots = $('#show_hidden_slots').is(':checked');\n                var showregistrationsonly = $('#show_registrations_only').is(':checked');\n\n                tablebody.find('tr').show();\n\n                if (event != undefined) {\n                    if (showregistrationsonly) {\n                        if ($('#show_registrations_only').is(event.target)) {\n                            $('#show_free_slots_only').prop('checked', false);\n                            showfreeslotsonly = false;\n                            saveuserpreference();\n                        }\n                        if (showfreeslotsonly) {\n                            if ($('#show_free_slots_only').is(event.target)) {\n                                $('#show_registrations_only').prop('checked', false);\n                                tablebody.find('tr.not_free_slot').hide();\n                                saveuserpreference();\n                            } else {\n                                $('#show_free_slots_only').prop('checked', false);\n                                tablebody.find('tr.not_registered').hide();\n                                saveuserpreference();\n                            }\n                        } else {\n                            tablebody.find('tr.not_registered').hide();\n                        }\n                    } else {\n                        if (showfreeslotsonly) {\n                            tablebody.find('tr.not_free_slot').hide();\n                        }\n                    }\n                } else {\n                    if (showregistrationsonly && showfreeslotsonly) {\n                        $('#show_free_slots_only').prop('checked', false);\n                        tablebody.find('tr.not_registered').hide();\n                        saveuserpreference();\n                    } else {\n                        if (showregistrationsonly) {\n                            tablebody.find('tr.not_registered').hide();\n                        } else if (showfreeslotsonly) {\n                            tablebody.find('tr.not_free_slot').hide();\n                        }\n                    }\n                }\n\n                if (!instance.studentview) {\n                    if (!showhiddenslots) {\n                        tablebody.find('tr.unavailable').hide();\n                    }\n                }\n                if (!showpastslots) {\n                    tablebody.find('tr.past_due').hide();\n                }\n                if (showmyslotsonly) {\n                    if (!instance.studentview) {\n                        tablebody.find('tr.not_my_slot').hide();\n                    }\n                }\n\n                var target = $('.organizer_filtertable');\n                if (target) {\n                    var filter = target.val().toUpperCase();\n                    if (filter) {\n                        var tr = tablebody.find('tr:visible:not(.info)');\n                        // Loop through all table rows, and hide those who don't match the search query.\n                        var i, j, td, text, found;\n                        for (i = 0; i < tr.length; i++) {\n                            found = false;\n                            td = tr[i].getElementsByTagName(\"td\");\n                            if (td) {\n                                for (j = 0; j < td.length; j++) {\n                                    text = extracttext(td[j]);\n                                    if (text) {\n                                        if (text.toUpperCase().indexOf(filter) > -1) {\n                                            found = true;\n                                            break;\n                                        }\n                                    }\n                                }\n                            }\n                            if (!found) {\n                                $(tr[i]).hide();\n                            }\n                        }\n                    }\n                }\n\n                tablebody.show();\n                $('#counttabrows').text(tablebody.find('tr:visible:not(.info)').length);\n\n                toggleInfo();\n            }\n\n            /**\n             * Check or uncheck the info row(s).\n             */\n            function toggleInfo() {\n                var tablebody = $('#slot_overview tbody');\n                var noninforows = tablebody.find('tr:not(.info)');\n                var noneexist = noninforows.length === 0;\n                var anyvisible = false;\n                noninforows.each(\n                    function() {\n                        if ($(this).css('display') !== 'none') {\n                            anyvisible = true;\n                        }\n                    }\n                );\n                var showpastslots = $('#show_past_slots').is(':checked');\n                var showmyslotsonly = $('#show_my_slots_only').is(':checked');\n                tablebody.find('tr.info').hide();\n                if (!anyvisible) {\n                    if (noneexist) {\n                        tablebody.find('tr.no_slots_defined').show();\n                    } else if (showpastslots && !showmyslotsonly) {\n                        tablebody.find('tr.no_slots').show();\n                    } else if (showpastslots && showmyslotsonly) {\n                        tablebody.find('tr.no_my_slots').show();\n                    } else {\n                        tablebody.find('tr.no_due_slots').show();\n                    }\n                }\n            }\n\n            /**\n             * Extract visible text from 'element' down thru DOM tree.\n             * @param {object} element element in which to search the text\n             * @return {string} text\n             */\n            function extracttext(element) {\n                var text, last, img;\n\n                last = $(element).clone().find(\"script,style\").remove().end();\n                text = last.text();\n                if (!text) {\n                    img = last.find('img:not(.icon)').first();\n                    var attr = img.attr('alt');\n                    if (typeof attr !== typeof undefined && attr !== false) {\n                        text = attr;\n                    }\n                }\n                return text;\n            }\n\n            /**\n             * Save userpreference to server.\n             */\n            function saveuserpreference() {\n                let slotsviewoptions = '';\n\n                slotsviewoptions += $('#show_my_slots_only').is(':checked') ? '1' : '0';\n                slotsviewoptions += $('#show_free_slots_only').is(':checked') ? '1' : '0';\n                slotsviewoptions += $('#show_hidden_slots').is(':checked') ? '1' : '0';\n                slotsviewoptions += $('#show_past_slots').is(':checked') ? '1' : '0';\n                slotsviewoptions += $('#show_registrations_only').is(':checked') ? '1' : '0';\n                slotsviewoptions += $('#show_all_participants').is(':checked') ? '1' : '0';\n\n                $.get(config.wwwroot + '/mod/organizer/slotsviewoptions.php', {\n                    sesskey: config.sesskey,\n                    slotsviewoptions: encodeURI(slotsviewoptions),\n                    userid: instance.userid\n                }, 'json');\n\n            }\n\n            /**\n             * Toggle single participantslist.\n             * @param {object} target element which has been clicked\n             */\n            function participantslistToggle(target) {\n                let clickeddiv = $(target).parent();\n                let targetclass = clickeddiv.attr('data-target');\n                $(targetclass).toggle();\n                let icon = clickeddiv.find('.collapseicon');\n                let isrc = $(icon).attr('src');\n                if (isrc.indexOf('minus-square') > 0) {\n                    isrc = isrc.replace('minus-square', 'plus-square');\n                } else {\n                    isrc = isrc.replace('plus-square', 'minus-square');\n                }\n                $(icon).attr('src', isrc);\n            }\n\n            /**\n             * Toggle all participantslists.\n             */\n            function participantslistsAllToggle() {\n                if (instance.registrationview == 0) {\n                    saveuserpreference();\n                }\n                let tablebody = $('#slot_overview tbody');\n                let showallparticipants = $('#show_all_participants').is(':checked');\n                if (showallparticipants == 1) {\n                    $('.mycollapse').show();\n                    let allicons = tablebody.find('.collapseicon');\n                    allicons.each(\n                        function() {\n                            let isrc = $(this).attr('src');\n                            isrc = isrc.replace('plus-square', 'minus-square');\n                            $(this).attr('src', isrc);\n                        }\n                    );\n                } else {\n                    $('.mycollapse').hide();\n                    let allicons = tablebody.find('.collapseicon');\n                    allicons.each(\n                        function() {\n                            let isrc = $(this).attr('src');\n                            isrc = isrc.replace('minus-square', 'plus-square');\n                            $(this).attr('src', isrc);\n                        }\n                    );\n                }\n            }\n\n            $('#show_past_slots').on('click', function() {\n                toggleAllSlots(event);\n            });\n            $('#show_all_participants').on('click', function() {\n                participantslistsAllToggle();\n            });\n            $('#show_my_slots_only').on('click', function() {\n                toggleAllSlots(event);\n            });\n            $('#show_free_slots_only').on('click', function() {\n                toggleAllSlots(event);\n            });\n            $('#show_hidden_slots').on('click', function() {\n                toggleAllSlots(event);\n            });\n            $('#show_registrations_only').on('click', function() {\n                toggleAllSlots(event);});\n            $('.organizer_filtertable').on('keyup', function() {\n                toggleAllSlots(event);\n            });\n            $('.collapseclick').on('click', function() {\n                participantslistToggle(event.target);\n            });\n            toggleAllSlots();\n            participantslistsAllToggle();\n            $('.organizer_filtertable').keypress(function(event) {\n                var keycode = (event.which ? event.which : event.keyCode);\n                if (keycode == '13') {\n                    return false;\n                } else {\n                    return true;\n                }\n            });\n        };\n\n        return instance;\n\n    }\n);\n"],"names":["define","$","config","instance","studentview","registrationview","userid","init","toggleAllSlots","event","undefined","saveuserpreference","tablebody","showpastslots","is","showmyslotsonly","showfreeslotsonly","showhiddenslots","showregistrationsonly","find","show","target","prop","hide","filter","val","toUpperCase","i","j","td","text","found","tr","length","getElementsByTagName","extracttext","indexOf","noninforows","noneexist","anyvisible","each","this","css","toggleInfo","element","last","clone","remove","end","attr","first","slotsviewoptions","get","wwwroot","sesskey","encodeURI","participantslistsAllToggle","isrc","replace","on","clickeddiv","parent","targetclass","toggle","icon","participantslistToggle","keypress","which","keyCode"],"mappings":"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"}